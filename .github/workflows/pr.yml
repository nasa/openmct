name: PR

on:
  push:
  pull_request:
    types:
      - opened
      - labeled

env:
  NODE_ENV: development
  NODE_VERSION: 22

jobs:
    generate_cache_key:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - id: generate_cache_key
            run: |
                lock_hash="$(sha256sum package-lock.json | awk '{print $1}')"
                echo "cache_key=node${NODE_VERSION}-deps-${lock_hash}" >> "$GITHUB_OUTPUT"
        outputs:
            cache_key: ${{ steps.generate_cache_key.outputs.cache_key }}
    build_and_cache_dependencies_if_needed:
        needs: generate_cache_key
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
                node-version: ${{ env.NODE_VERSION }}
                cache: npm
          - uses: actions/cache/restore@v4
            id: node_deps_restore_cache
            with:
              path: |
                node_modules
                dist
              key: ${{ needs.generate_cache_key.outputs.cache_key }}
          - run: npm ci
            if: steps.node_deps_restore_cache.outputs.cache-hit != 'true' || contains(github.event.pull_request.labels.*.name, 'build:clean')
          - name: Remove build:clean label (if present)
            if: contains(github.event.pull_request.labels.*.name, 'build:clean')
            uses: actions/github-script@v6
            with:
              script: |
                const { owner, repo, number } = context.issue;
                const labelToRemove = 'build:clean';
                try {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: number,
                    name: labelToRemove
                  });
                } catch (error) {
                  core.warning(`Failed to remove ' + labelToRemove + ' label: ${error.message}`);
                }
          - uses: actions/cache/save@v4
            id: node_deps_save_cache
            if: steps.node_deps_restore_cache.outputs.cache-hit != 'true' || contains(github.event.pull_request.labels.*.name, 'build:clean')
            with:
              path: |
                node_modules
                dist
              key: ${{ needs.generate_cache_key.outputs.cache_key }}
        outputs:
            cache_key: ${{ needs.generate_cache_key.outputs.cache_key }}
    lint:
        needs: 
            - build_and_cache_dependencies_if_needed
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
                node-version: ${{ env.NODE_VERSION }}
                cache: npm
          - uses: actions/cache/restore@v4
            with:
              path: |
                node_modules
                dist
              key: ${{ needs.build_and_cache_dependencies_if_needed.outputs.cache_key }}
          - run: npm run lint
    unit-test:
        needs: 
            - build_and_cache_dependencies_if_needed
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
                node-version: ${{ env.NODE_VERSION }}
                cache: npm
          - uses: actions/cache/restore@v4
            with:
              path: |
                node_modules
                dist
              key: ${{ needs.build_and_cache_dependencies_if_needed.outputs.cache_key }}
          - uses: browser-actions/setup-chrome@v1
          - run: |
              mkdir -p dist/reports/tests/
              npm run test
          - uses: codecov/codecov-action@v4
            if: always()
            with:
              token: ${{ secrets.CODECOV_TOKEN }}
              files: ./coverage/unit/lcov.info
              flags: unit
              name: unit-test-${{ github.run_id }}
              fail_ci_if_error: false
          - uses: actions/upload-artifact@v4
            if: always()
            with:
              name: unit-test-results
              path: dist/reports/tests/
              if-no-files-found: warn
          - uses: actions/upload-artifact@v4
            if: always()
            with:
              name: unit-test-coverage
              path: coverage
              if-no-files-found: warn
          - name: Collect version artifacts
            if: always()
            run: |
              mkdir -p /tmp/artifacts
              printenv NODE_ENV > /tmp/artifacts/NODE_ENV.txt || true
              npm -v > /tmp/artifacts/npm-version.txt
              node -v > /tmp/artifacts/node-version.txt
              ls -latR > /tmp/artifacts/dir.txt
          - uses: actions/upload-artifact@v4
            if: always()
            with:
              name: unit-test-artifacts
              path: /tmp/artifacts
              if-no-files-found: warn